
https://www.zhihu.com/question/434996610/answer/2274744127

内容较多涉及较广，画了张思维导图，可以先看看好有个总体把握

![](images/Pasted%20image%2020230101200908.png)

首先是存储器的层次结构，大家应该都很熟悉了，就是那个金字塔图，再来看看：

![](images/Pasted%20image%2020230101200936.png)

关于这个图就不做解释了，大家应该很熟悉很熟悉很熟悉，放在这里只是过过眼，说明讲述的 Cache 位于哪个层次。下面直接来看 Cache 的一些问题。

## **基本问题**

对于 cache 的设计有 4 个基本问题：块的放置，块的识别，块的写策略，块的替换，在这之前先声明一下名词的事，Cache 的行和块，基本上就一回事，不论英文里面的 Cache Line 还是 Cache block 很多地方就是混用的，不要纠结有什么不同，只不过有时会说 Cache Line 里面的数据由多个 Data blocks 组成的，主要是在知乎上看到过这个问题，有人纠结，这里给出自己的见解。另外后面会涉及到数据和指令两个名词，狭义上讲数据就是数据，指令就是指令，但有时为了说着顺口指令也是包括在数据里面的，因为数据这个词本来就包括很多意思是吧，后面遇到这也不要纠结，从上下文应该很好判断具体什么意思。再者就是 CPU 和实际的 CPU 芯片，CPU 芯片包括的东西很多，比如说 L1 L2 级缓存，但一般后文说的 CPU 单指处理核心。

### **块的放置**

Cache 很小，主存很大，主存的块放在 Cache 哪个地方？三种策略，就是常说的 直接相联，组相联，全相联

**1、直接相联**

主存中的每一块只能放在 Cache 的唯一位置，映射方法：块地址行数(块地址mod(cache行数))(块地址\mod (cache 行数))

图示如下：

![500](images/Pasted%20image%2020230101200955.png)

优缺点：容易实现，命中时间短，结构简单但冲突率高

**2、全相联**

主存块能放在 Cache 的任意一行

图示如下：

![500](images/Pasted%20image%2020230101201010.png)

优缺点：结构复杂但命中率高

**3、N 路组相联**

所谓组指的是若干 Cache Line 的集合，N 路指的是每个组中包含的 Cache Line 的行数，也称为相联度。一个主存块能放在一组的任意一行中。

图示如下：

![500](images/Pasted%20image%2020230101201024.png)

优缺点：具备直接相连和全相联的特点

### **块的识别**

CPU 根据地址直接去 Cache 中获取数据时，如何确定 Cache 中哪一行里有我(CPU) 所需要的数据呢？所以一个 Cache Line 里面除了数据还得有其他的东西来标志数据才行，一般就是有效位 V 和 标志 tag。如此便可以将 Cache Line 分为三部分：

1.  V：有效位，指明该 Cache Line 是否与某主存块建立映射关系，数据是否有效
2.  Tag：标记位，包含了地址信息，可以用来区分所有可能映射到该行的主存块
3.  Data：存放在该行的数据

这里我们就可以对地址进行划分，划分方式如下：

![500](images/Pasted%20image%2020230101201048.png)
![](images/Pasted%20image%2020230101201318.png)
### **块的替换**

当 miss 冲突的时候，就需要决定将哪个块给替换掉，直接相联不需要替换策略，因为其本身的映射方式已经决定了一个主存块应该放进哪个 Cache Line。而组相联和全相联是需要替换策略的，常见的替换策略如下：

-   随机替换
-   先进先出
-   最近最少使用(LRU)

这些[替换算法](https://www.zhihu.com/search?q=%E6%9B%BF%E6%8D%A2%E7%AE%97%E6%B3%95&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A2274744127%7D)应该都很熟悉，像是页面替换算法与其也类似，但是有一点区别，在 Cache 里，所有的替换算法由硬件来实现，而页面替换算法可由软件实现。虽然硬件本身复杂，但是由硬件来实现某个算法的话，说明该算法容易实现，复杂的东西硬件是“做不了”的。

随机替换算法很容易实现，需要一个随机数产生器，我去查了查资料，这个随机数产生器在现实里面还是挺好实现的，它是把物理上不可预测的随机噪声转换为电信号，具体啥啥啥的就不说了，emmm 我也不懂，不能乱说，就点到为止。











