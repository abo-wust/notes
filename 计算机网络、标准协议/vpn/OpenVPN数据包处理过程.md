已剪辑自: [https://zhuanlan.zhihu.com/p/28727570](https://zhuanlan.zhihu.com/p/28727570)



**1.理论分析**

**发送数据流程**

应用层的外出数据，经过系统调用接口传入核心TCP/IP层做处理，在TCP/IP经过路由到虚拟网卡，虚拟网卡的网卡驱动发送处理程序hard\_start\_xmit()将数据包加入skb表并完成数据包从核心区到用户区的复制，OpenVPN调用虚拟网卡的字符处理程序tun\_read(),读取到设备上的数据包，对读取的数据包使用SSL协议做封装处理后，通过socket系统调用发送出去。

**接收数据流程**

物理网卡接收数据包，经过核心的TCP/IP上传到OpenVPN，OpenVPN通过link\_socket\_read()接收数据包，使用SSL协议进行解包处理，经过处理的数据包OpenVPN调用虚拟网卡的字符处理程序tun\_write()写入虚拟网卡的字符设备，设备驱动程序完成数据从用户区到核心区的复制，并将数据写入skb链表，然后调用网卡netif\_rx()接收程序，数据包再次进入系统TCP/IP协议栈，传到上层应用程序。

![](images/Pasted%20image%2020221201233131.png)

图1 数据流向示意图

**2\. 实验测试**

OpenVPN通过虚拟的网卡设备TUN/TAP，建立vpn隧道，所有经过隧道传输的数据都经过加密处理，对于应用程序而言，隧道是透明的，不需要应用程序做任何额外的工作。

设备A，win10系统，运行openvpn服务端，物理网卡IP地址为192.168.1.110，虚拟IP地址为10.8.0.1

设备B，ubuntu16系统，运行openvpn客户端，物理网卡IP地址为192.168.1.101，虚拟IP地址为10.8.0.6

（1） 设备A上openvpn服务端启动，设备B上客户端连接服务端，建立vpn隧道，设备A和设备B上都会产生一个虚拟的网卡设备。vpn隧道建立之后，客户端和服务端根据配置的IP地址池，会被分配一个虚拟网络的IP地址，如下图所示。

设备A虚拟网卡：

![](images/Pasted%20image%2020221201233137.png)

设备B虚拟网卡：

![](images/Pasted%20image%2020221201233142.png)

（2） 设备A和设备B上的运行的应用程序分两种情况讨论。

（2.1）当使用物理网卡的地址段进行通信时，数据不走vpn通道，不会路由到虚拟网卡上，还是普通的数据通信，如下图所示。

在设备A和设备B上分别运行sokit程序，启动TCP服务端和客户端程序，建立TCP连接，使用wireshark在客户端抓数据包，发现数据并没有进行加密操作，如下图所示。

![](images/Pasted%20image%2020221201233242.png)

图2 Sokit服务端

![](images/Pasted%20image%2020221201233254.png)

图3 wireshark抓取物理网卡数据

（2.2）当使用虚拟网络的IP地址进行数据通信时，数据走vpn通道，会路由到虚拟网卡上，数据都经过加密，如下图所示。

![](images/Pasted%20image%2020221201233307.png)

图4 Wireshark抓取tun0虚拟网卡数据

当数据流经虚拟网卡时，数据还是明文，经过openvpn程序处理后，经过物理网卡再次发送出去，数据变为密文。

![](images/Pasted%20image%2020221201233317.png)

图5 Wireshark抓取物理网卡数据

