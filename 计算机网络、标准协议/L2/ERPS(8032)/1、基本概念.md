

ERPS域：ERPS域由整数表示的ID来标识，一组配置了相同的域ID和控制VLAN，并且相互联通的交换机群体构成一个ERPS域。

1、ERPS域的组成结构

ERPS环：一个ERPS环物理上对应一个环形连接的以太网拓扑，一个ERPS域由彼此相接的多个ERPS环构成，其中一个为主环，其他环为子环。ERPS由整数表示的ID来标识。每个ERPS环都是其所在ERPS域的一个局部单元。一个ERPS域可以只包含一个ERPS环。在单环情况下，既可以把环配置为主环，也可以配置成子环，在应用上具有相同的效果。环的配置由用户自主决定。

控制VLAN：每个ＥＲＰＳ域有两个控制ＶＬＡＮ— —主控制ＶＬＡＮ和子控制ＶＬＡＮ，分别承载主环协议报文和子环协议报文的传输。主环的ＥＲＰＳ端口既要属于主控制ＶＬＡＮ，也要属于子控制ＶＬＡＮ；子环的ＥＲＰＳ端口只属于子控制ＶＬＡＮ。

数据VLAN：数据ＶＬＡＮ用来传输数据报文。数据ＶＬＡＮ中可以包含ＥＲＰＳ端口，也可以包含非ＥＲＰＳ端口。

主节点：是ＥＲＰＳ环上的主要决策和控制节点。每个ＥＲＰＳ环必须有一个，而且只能有一个主节点。

传输节点：ＥＲＰＳ环上除主节点外的其他节点都可以成为传输节点。

边缘节点：也可以叫做互联节点。是连接多个环的节点。

主端口和副端口：主节点和传输节点接入以太网环的两个端口中，一个为主端口，另一个为副端口，由用户的配置决定。

主节点的主端口和副端口在功能上是有区别的。主节点从主端口发送环路状态监测报文，如果能从副端口收到该报文，说明本节点所在ＥＲＰＳ环网完整，因此需要阻塞副端口防止数据环路；相反如果在设定时间内收不到该报文，说明环网故障，此时需要打开副端口来保证环网各节点间的正常通信。

传输节点的主端口和副端口在功能上没有区别。

>注：主环主节点的副端口处于阻塞状态时，不仅要禁止数据报文通过，同时要禁止子环的协议报文通过；打开时则同时放开数据和子环协议报文。也就是说，子环的协议报文在主环中视为数据报文处理。传输节点类似。

公共端口和边缘端口：边缘节点接入子环的两个端口中，一个为公共端口，另一个为边缘端口。公共端口是边缘节点上主环和子环公共链路两端的端口，而边缘端口是只接入了子环的端口。概念上并不把公共端口视为子环上的端口，而是看作主环的一部分，即公共链路是主环上的链路（有两个或两个以上的边缘节点时，边缘节点之间的链路叫做公共链路），而不是子环的链路，公共链路的状态变化只报给主环主节点，子环主节点不需要知道。公共端口和边缘端口的角色由用户配置决定。


2、主节点状态

主节点由两种状态：
（1）Complete State（完整状态）
    当环网上所有的链路都处于ＵＰ状态，主节点可以从副端口收到自己发送的ＨＥＬＬＯ报文，就说明主节点处于Complete状态。主节点的状态反映ＥＲＰＳ环的状态。因此ＥＲＰＳ环也处于Complete状态。此时主节点会阻塞副端口，以防止数据报文在环形拓扑上形成广播环路。

（２）Failed State（故障状态）
    当环网上所有的链路都处于Down状态时，就说主节点处于Failed状态，此时主节点放开副端口以保证环网上各节点通信不被中断。

３、传输节点状态
（1）Link-Up State（UP状态）
    传输节点的主端口和副端口都处于ＵＰ状态时，就说传输节点处于Link-Up状态。

（2）Link-Down State（Down状态）
    传输节点的主端口和副端口都处于Down状态时，就说传输节点处于Link-Down状态。

（3）Preforwarding State（临时阻塞状态）
    传输节点的主端口或副端口处于阻塞状态时，就说传输节点处于Preforwarding状态。 
    当处于UP状态的传输节点检测到主端口或副端口发生链路Down时，从UP状态直接迁移到Down状态，并向主节点发送Link-Down报文。而当处于Down状态的节点要恢复UP状态时，不能直接迁移到UP状态（容易形成广播环路），而是由Down状态迁移到Preforwarding状态，并阻塞恢复的端口。此时等待该传输节点收到主节点发送的COMPLETE-FLUSH-FDB报文时，再迁移到UP状态。

４、节点端口状态
（1）Block（阻塞状态）
    端口处于阻塞状态。当节点端口是主节点的副端口时，禁止数据报文通过，允许协议报文通过；当节点端口是主节点外的其他节点时，同时禁止协议报文和数据报文通过。

（2）Forward（打开状态）
    端口处于打开状态。此时协议报文和数据报文均可以通过。


５、ERPS协议的基本原理

（１）Polling机制
Polling机制是ＥＲＰＳ环的主节点主动检测环网健康状态的机制，主节点周期性地从其主端口发送HELLO报文，依次经过各传输节点在环上传播。如果主节点能从副端口收到自己发送的ＨＥＬＬＯ报文，说明环网链路完整；而如果在设定时间内没有收到ＨＥＬＬＯ报文，就认为环网发生故障。
    
处于Failed状态的主节点从副端口收到自己发送的HELLO报文，立即迁移到Complete状态，放开副端口并刷新FDB。同时还会从主端口发送COMPLETE_FLUSH_FDB报文通知所有传输节点打开临时阻塞端口和刷新FDB。

（2）链路状态变化通知机制
链路状态变化通知机制提供了比Polling机制更快的应对环网拓扑改变的处理机制，发起点是传输节点。每个传输节点时刻在监测自己端口的状态，一旦状态发生变化，就通过发送通知报文将这种变化通知主节点，然后由主节点决定如何处理。传输节点监测自己端口是UP，还是Down状态，然后从配对的ERPS端口向环上发送LINK-UP或LINK-DOWN报文。

（3）主环上子环协议报文通道状态检查机制
该机制应用在多子环与主环相交的组网中。子环的协议报文需要通过主环提供的通道在边缘节点与边缘节点的端口之间传播。当主环链路出现故障，公共链路故障且主环有一条以上的非公共链路故障，使得边缘节点之间无法通信时，子环主节点将收不到自己发出的Hello报文，超过设定的时间后，子环主节点迁移到Failed状态，打开副端口。

该机制需要两个或两个以上的边缘节点配合，在主节点的副端口打开之前，阻塞边缘节点的边缘端口，从而避免子环间形成数据环路。
    


