参考资料：

  [https://support.huawei.com/enterprise/zh/doc/EDOC1100219441/abf23eb3#ZH-CN\_CONCEPT\_0000001211505719](https://support.huawei.com/enterprise/zh/doc/EDOC1100219441/abf23eb3#ZH-CN_CONCEPT_0000001211505719)

  [https://support.huawei.com/enterprise/zh/doc/EDOC1000047392/6bb92fd8](https://support.huawei.com/enterprise/zh/doc/EDOC1000047392/6bb92fd8)


1. **ARP简介**

**定义**

地址解析协议ARP（Address Resolution Protocol）是用来将IP地址解析为MAC地址的协议。

  **目的**

  在局域网中，当主机或其它网络设备有数据要发送给另一个主机或设备时，它必须知道对方的网络层地址（即IP地址）。但是仅有IP地址是不够的，因为IP数据报文必须封装成帧才能通过物理网络发送，因此发送方还必须有接收方的物理地址（MAC地址），所以需要一个从IP地址到物理地址的映射。ARP就是实现这个功能的协议。


2. **ARP基本原理**

**ARP报文格式**

ARP请求和应答的报文格式如下图所示，

报文的长度是42字节。前14字节的内容表示以太网首部，后28字节的内容表示ARP请求或应答报文的内容。

![](images/Pasted%20image%2020221201231912.png)
*ARP请求和应答报文格式*

主要字段解释如下：

- Hardware Type：硬件地址的类型。对于以太网，该类型的值为“1”。
- Protocol Type：映射的协议地址类型。对于IP地址，该值为0x0800。
- Hardware Length：硬件地址长度。对于ARP请求或应答来说，该值为6。
- Protocol Length：协议地址长度。对于ARP请求或应答来说，该值为4。
- OP：操作类型。1表示ARP请求，2表示ARP应答。
- Ethernet Address of sender：发送方MAC地址。
- IP Address of sender：发送方IP地址。
- Ethernet Address of destination：接收方MAC地址。
- IP Address of destination：接收方IP地址。



**ARP地址解析过程**

动态ARP通过广播ARP请求和单播ARP应答这两个过程完成地址解析。

![](images/Pasted%20image%2020221201231755.png)

*ARP地址解析过程*

当需要通信的两台主机处于同一网段时，如上图中的Host_1和Host_3，Host_1要向Host_3发送数据。

1) 首先，Host_1会查找自己本地缓存的ARP表，确定是否包含Host_3对应的ARP表项。如果Host_1在ARP表中找到了Host_3对应的MAC地址，则Host_1直接利用ARP表中的MAC地址，对数据报文进行帧封装，并将数据报文发送给Host_3。如果Host_1在ARP表中找不到Host_3对应的MAC地址，则先缓存该数据报文，并以广播方式发送一个ARP请求报文。如上图中所示，OP字段为1表示该报文为ARP请求报文，ARP请求报文中的源MAC地址和源IP地址为Host_1的MAC地址和IP地址，目的MAC地址为全0的MAC地址，目的IP地址为Host_3的IP地址。
2) Switch_1收到ARP请求报文后，将该ARP请求报文在同一广播域内转发。
3) 同一广播域内的主机Host_2和Host_3都能接收到该ARP请求报文，但只有被请求的主机（即Host_3）会对该ARP请求报文进行处理。Host_3比较自己的IP地址和ARP请求报文中的目的IP地址，当两者相同时进行如下处理：将ARP请求报文中的源IP地址和源MAC地址（即Host_1的IP地址和MAC地址）存入自己的ARP表中。之后以单播方式发送ARP应答报文给Host_1，ARP应答报文内容如上图中所示，OP字段为2表示该报文为ARP应答报文，源MAC地址和源IP地址为Host_3的MAC地址和IP地址，目的MAC地址和目的IP地址为Host_1的MAC地址和IP地址。
4) Switch_1收到ARP应答报文后，将该ARP应答报文转发给Host_1。Host_1收到ARP应答报文后，将Host_3的MAC地址加入到自己的ARP表中以用于后续报文的转发，同时将数据报文进行帧封装，并将数据报文发送给Host_3。

当需要通信的两台主机处于不同网段时，如上图中的Host_1和Host_4，Host_1上已经配置缺省网关，Host_1首先会发送ARP请求报文，请求网关Router的IP地址对应的MAC地址。Host_1收到ARP应答报文后，将数据报文封装并发给网关，再由网关将数据报文发送给目的主机Host_4。Host_1学习网关IP地址对应的ARP表项的过程，以及网关设备学习Host_4的IP地址对应的ARP表项的过程与上述同网段主机Host_1和Host_3之间进行ARP地址解析的过程类似，不再赘述。



3. **ARP老化机制**
- **高速缓存**
如果每次HOSTA和HOSTB通信前都要发送一个广播的ARP请求报文的话，会极大的增加网络负担。而且网络上的所有机器都必须接收和处理这个广播的ARP请求报文，也极大的影响了网络运行效率。
为了解决以上问题，每台主机上都维护着一个高速缓存，这是ARP高效运行的一个关键。在这个高速缓存中，存放最近获得的IP地址到MAC地址的映射关系。
发送方在每次发送报文时，都先在缓存中查找目标IP地址所对应的MAC地址。如果ARP缓存中有对应的MAC地址，主机就不会再发送ARP请求报文，而是直接将报文发至这个MAC地址。如果ARP缓存中没有对应的MAC地址时，主机才会发送广播的ARP请求报文。
- **动态ARP表项的老化超时时间**
当HOSTA收到HOSTB的ARP回应时，在HOSTA的缓存中会形成HOSTB的IP地址和MAC地址的映射关系。但是，如果HOSTB发生故障或者更换了网卡时，HOSTA没有得到关于HOSTB的任何通告，于是HOSTA仍会继续将报文发送给HOSTB。造成地址解析出现错误的原因就是HOSTA中的映射表的信息没有得到及时的更新。
为了减少地址解析过程中所出现的错误，ARP高速缓存中的表项一般都会设定一个定时器。当达到定时器的动态ARP表项的老化超时时间，设备进行老化探测，如果探测失败，删除该表项；否则，保留该表项。
通过设置定时器，在地址解析过程中出现错误的现象得到了改善但并没有完全消除，其原因在于时延。如果定时器的动态ARP表项的老化超时时间是N秒，发送方只有等到N秒后才能检测到接收方出现了故障，在此期间发送方缓存表的信息还是没有得到及时的更新。
- **动态ARP表项的老化探测次数**
除了设置定时器中动态ARP表项的老化超时时间，还可以通过设置动态的探测次数来减少地址的解析错误。在将一条动态ARP表项老化之前，系统先进行探测，如果超过设置的探测次数后探测的目标主机仍没有应答，则此ARP表项将被删除。
- **动态ARP表项的老化探测模式**
ARP表项老化之前，接口会发送ARP老化探测报文。老化探测报文可以是单播报文，也可以是广播报文。缺省情况下，接口以广播模式发送ARP老化探测报文。
当对端设备的IP地址不变化而MAC地址频繁更新时，建议使用广播模式发送ARP老化探测报文。
当对端设备MAC地址不变，当前网络带宽资源特别紧缺，且ARP表项的老化时间设置的比较小时，建议使用单播模式发送ARP老化探测报文。
当其他厂商设备与华为设备互联时，其他厂商设备接收到目的MAC地址为广播地址的ARP老化探测报文后，若ARP表项中已存在华为设备的IP地址与MAC地址映射，则丢弃该广播ARP老化探测报文。华为设备由于收不到该探测报文的应答报文，而删除对应的ARP表项，导致网络侧过来的流量不通。这种特殊情况下华为设备需要配置成以单播方式发送ARP老化探测报文，其他厂商设备需要配置成可以响应该单播探测报文。
- **二层拓扑探测功能**
二层拓扑探测功能，是指当二层接口的状态由Down变为Up时，二层接口所属VLAN对应的所有ARP表项的老化超时时间变为0，使设备重新发送ARP探测报文，更新二层接口所属VLAN对应的所有ARP表项。


4. **ARP类型**

**动态ARP**

动态ARP表项由ARP协议通过ARP报文自动生成和维护，可以被老化，可以被新的ARP报文更新，也可以被静态ARP表项覆盖。当到达老化时间、接口Down时会删除相应的动态ARP表项。

动态ARP适用于拓扑结构复杂、通信实时性要求高的网络。



**静态ARP**

静态ARP表项是由网络管理员手工建立的IP地址和MAC地址之间固定的映射关系。静态ARP表项不会被老化，不会被动态ARP表项覆盖。

正常情况下网络中设备可以通过ARP协议进行ARP表项的动态学习，生成的动态ARP表项可以被老化，可以被更新。但是当网络中存在ARP攻击时，设备中动态ARP表项可能会被更新成错误的ARP表项，或者被老化，造成合法用户通信异常。

静态ARP表项不会被老化，也不会被动态ARP表项覆盖，可以保证网络通信的安全性。静态ARP表项可以限制本端设备和指定IP地址的对端设备通信时只使用指定的MAC地址，此时攻击报文无法修改本端设备的ARP表中IP地址和MAC地址的映射关系，从而保护了本端设备和对端设备间的正常通信。一般在网关设备上配置静态ARP表项。

静态ARP表项分为短静态ARP表项和长静态ARP表项。

- **短静态ARP表项：**
手工建立IP地址和MAC地址之间固定的映射关系，未同时指定VLAN和出接口。
如果出接口是处于二层模式的以太网接口，短静态ARP表项不能直接用于报文转发。当需要发送报文时，设备会先发送ARP请求报文，如果收到的ARP应答报文中的源IP地址和源MAC地址与所配置的IP地址和MAC地址相同，则将收到ARP应答报文的VLAN和接口加入该静态ARP表项中，后续设备可直接用该静态ARP表项转发报文。

- **长静态ARP表项：**
手工建立IP地址和MAC地址之间固定的映射关系，并同时指定该ARP表项所在VLAN和出接口。
长静态ARP表项可以直接用于报文转发。建议用户采用长静态ARP表项。


**免费ARP**

主机主动使用自己的IP地址作为目标地址发送ARP请求，此种方式称免费ARP。免费ARP有三方面的作用：

- **用于检查重复的IP地址：** 正常情况下不会收到ARP回应，如果收到，则表明本网络中存在与自身IP地址重复的地址。
- **用于通告一个新的MAC地址：** 发送方更换了网卡，MAC地址变化了，为了能够在ARP表项老化前通告所有主机，发送方可以发送一个免费ARP。
- **在VRRP备份组中用来通告主备发生变换：** 发生主备变换后，MASTER交换机会在备份组中发送一个免费ARP报文来通告发生了主备变换。



5. **Proxy ARP**

如果ARP请求是从一个网络的主机发往同一网段但不在同一物理网络上的另一台主机，那么连接这两个网络的设备就可以回答该ARP请求，这个过程称作ARP代理(Proxy ARP)。

Proxy ARP有以下特点：

- Proxy ARP部署在网关上，网络中的主机不必做任何改动。
- Proxy ARP可以隐藏物理网络细节，使两个物理网络可以使用同一个网络号。
- Proxy ARP只影响主机的ARP表，对网关的ARP表和路由表没有影响。
Proxy ARP分为路由式Proxy ARP、VLAN内Proxy ARP和VLAN间Proxy ARP。



**路由式Proxy ARP**

路由式Proxy ARP就是使那些在同一网段却不在同一物理网络上的网络设备能够相互通信的一种功能。

在实际应用中，如果连接设备的主机上没有配置缺省网关地址（即不知道如何到达本网络的中介系统），此时将无法进行数据转发。

如下图所示，Host_1的IP地址为172.16.1.10/16，Host_2的IP地址为172.16.2.20/16，Host_1与Host_2处于同一网段。Switch通过VLAN10和VLAN20连接两个网络，VLANIF10和VLANIF20的IP地址不在同一个网段。

![](images/Pasted%20image%2020221201231819.png)

*路由式Proxy ARP典型组网应用*

当Host\_1需要与Host\_2通信时，由于目的IP地址与本机的IP地址为同一网段，因此Host\_1以广播形式发送ARP请求报文，请求Host\_2的MAC地址。但是，由于两台主机处于不同的物理网络（不同广播域）中，Host\_2无法收到Host\_1的ARP请求报文，因此也就无法应答。

通过在Switch上启用路由式Proxy ARP功能，可以解决此问题。启用路由式Proxy ARP后，Switch收到ARP请求报文后，Switch会查找路由表。由于Host\_2与Switch直连，因此Switch上存在到Host\_2的路由表项。Switch使用自己的MAC地址给Host\_1发送ARP应答报文。Host\_1将以Switch的MAC地址进行数据转发。此时，Switch相当于Host\_2的代理。如上图所示，Host\_1上的ARP表项中到目的地址Host\_2的IP地址对应的MAC地址为Switch的VLANIF10接口的MAC地址。



**VLAN内Proxy ARP**

如果两个用户属于相同的VLAN，但VLAN内配置了端口隔离。此时用户间需要三层互通，可以在关联了VLAN的接口上启动VLAN内Proxy ARP功能。

如下图所示，Host_1和Host_2是Switch设备下的两个用户。连接Host_1和Host_2的两个接口在Switch属于同一个VLAN10。

![](images/Pasted%20image%2020221201231825.png)

*VLAN内Proxy ARP典型组网应用*

由于在Switch上配置了VLAN内不同接口彼此隔离，因此Host\_1和Host\_2不能直接在二层互通。

若Switch的接口使能了VLAN内Proxy ARP功能，可以使Host\_1和Host\_2实现三层互通。Switch的接口在接收到目的地址不是自己的ARP请求报文后，Switch并不立即丢弃该报文，而是查找该接口的ARP表项。如果存在Host\_2的ARP表项，则将自己的MAC地址发送给Host\_1，并将Host\_1发送给Host\_2的报文代为转发。实际上此时Switch相当于Host\_2的代理。



**VLAN间Proxy ARP**

如果两台主机处于相同网段但属于不同的VLAN，用户间要进行三层互通，可以在关联了这些VLAN的接口（例如VLANIF接口或者子接口）上使能VLAN间Proxy ARP功能。

如下图所示，Host_1和Host_2是Switch设备下的两个用户，Host_1和Host_2处于相同网段，但Host_1属于VLAN10，Host_2属于VLAN20。

![](images/Pasted%20image%2020221201231831.png)

*VLAN间Proxy ARP典型组网应用*

由于Host\_1和Host\_2属于不同的Sub-VLAN，Host\_1和Host\_2不能直接实现二层互通。

如果Switch上使能了VLAN间Proxy ARP功能，可以使Host\_1和Host\_2实现三层互通。Switch的接口在接收到目的地址不是自己的ARP请求报文后，并不立即丢弃该报文，而是查找ARP表项（包括动态学习的ARP表项和静态配置的ARP表项）。如果存在Host\_2的ARP表项，则将自己的MAC地址发送给Host\_1，并将Host\_1发送给Host\_2的报文代为转发。实际上此时Switch相当于Host\_2的代理。
















