

### 定时关注任务，需要注意相关修改

1、lm81drv.c 里面 lm81_detect 初始化两片CT80 的地方，等硬件确认器件都焊接了之后回退当前的修改



### snmp 调试

```
#packet netif create eth-test port 6 0000.0000.1122

packet netif create eth-test port 6 000e.5e00.0001
ifconfig eth-test 192.168.4.28


#1，CPU自定义reaosn方法
#自定义cpu reason，设置cpu reason的queue
qos cpu-reason 600 map-to queue-id 1 reason-group 15

#设置cpu reason的dest
qos cpu-reason 600 dest-to local-cpu


nexthop add misc cpu-reason 0x5401 reason-id 600

port 6 port-cross-connect nhid 0x5401




# 另外一个交换口配置通过knet上cpu
packet netif create eth-test port 16 000e.5e00.0011
ifconfig eth-test 192.168.8.77


qos cpu-reason 601 map-to queue-id 2 reason-group 15

qos cpu-reason 601 dest-to local-cpu


nexthop add misc cpu-reason 0x5402 reason-id 601

port 16 port-cross-connect nhid 0x5402
```

knet 收发包计数寄存器
```
read DmaPktRxStats 6
read DmaPktRxStats 7

read DmaPktTxStats 2
read DmaPktTxStats 3


read DmaPktStatsCfg 0
write DmaPktStatsCfg 0 0 0

```


### phy mapping

表示端口的bitmap：phybitmap0 0x0000FFFF，phybitmap1 0x0000FFFF，表示第一组用的两个MDIO分别用了那些PHY addr
```
chip phy-scan para gebitmap0 0x0000FFFF gebitmap1 0x0000FFFF mdio-ctrl-type 0 mdio-ctrl-id 0

//5.6.8命令格式
chip phy-scan para gebitmap0 0x000001FE gebitmap1 0x000001FE control-id 0
```


表示端口的bitmap：phybitmap0 0x000000FF，phybitmap1 0x0000000F，表示第二组用的两个MDIO分别用了那些PHY addr
```
chip phy-scan para gebitmap0 0x000000FF gebitmap1 0x000000FF mdio-ctrl-type 0 mdio-ctrl-id 1
```


关掉 phy-scan 后读对应的接口link 状态，示例给的control-id 是 0。主控八个 ge 口，前四个口bus-id 为 3。
```
chip phy-scan disable
chip read mdio lchip 1 ge control-id 1 bus-id 3 phy-id 1 reg-addr 0x1
chip read mdio lchip 1 ge control-id 1 bus-id 3 phy-id 2 reg-addr 0x1
chip read mdio lchip 1 ge control-id 1 bus-id 3 phy-id 3 reg-addr 0x1
chip read mdio lchip 1 ge control-id 1 bus-id 3 phy-id 4 reg-addr 0x1

chip read mdio lchip 1 ge control-id 1 bus-id 2 phy-id 1 reg-addr 0x1
chip read mdio lchip 1 ge control-id 1 bus-id 2 phy-id 2 reg-addr 0x1
chip read mdio lchip 1 ge control-id 1 bus-id 2 phy-id 3 reg-addr 0x1
chip read mdio lchip 1 ge control-id 1 bus-id 2 phy-id 4 reg-addr 0x1
```

ge4 子卡插到 3 槽时读取 8614 的状态：
```
chip read mdio lchip 1 ge control-id 0 bus-id 0 phy-id 1 reg-addr 0x1
chip read mdio lchip 1 ge control-id 0 bus-id 0 phy-id 2 reg-addr 0x1
chip read mdio lchip 1 ge control-id 0 bus-id 0 phy-id 3 reg-addr 0x1
chip read mdio lchip 1 ge control-id 0 bus-id 0 phy-id 4 reg-addr 0x1
```


硬件给不出具体的 qsgmii 映射关系，需要挨个配置验证
```
chip phy mapping lport 52 mdio-bus 1 phy-address 1
chip phy mapping lport 53 mdio-bus 1 phy-address 2
chip phy mapping lport 54 mdio-bus 1 phy-address 3
chip phy mapping lport 55 mdio-bus 1 phy-address 4

```

调试 phy mapping 时可以打开sdk 的调试开关
```
debug on
debug chip peri sys debug-level func info error
debug chip peri ctc debug-level func info error
debug error on

#关闭调试
no debug on
debug error off
```


### ge4 板卡

```
btest spi firmware w 0 0xc 1 0x18
btest spi firmware w 0 0x95 1 0x1
btest spi firmware w 0 0x96 1 0x4
btest spi firmware w 0 0x98 1 0x1
btest spi firmware w 0 0x99 1 0x4


```


### 长按 rst 清除配置

在 `dev_intr.c`中初始化注册中断处理函数，对应的 `GPIO`号对照软硬件接口表确认，然后还需要写`CPLD`的`0x7`地址配置长按`rst`的时间，默认值是`0`屏蔽长按`rst`操作，写寄存器值`1~15`对应相应的秒数。


### 产测

```
test eeprom 1: pass
test emmc   1: pass
test sw-ic  1: pass    sw-ic 是指本板的7118 芯片
ct80 
ct80-1                看Excel说明
phy yt8531_1 
phy yt8531_2
phy ee1512p_1 
phy ee1512p_2 
phy yt8614_1
phy yt8614_2
phy yt8614_3
RC38612 
FPGA 
serdes 检测
power1
power2
风扇
```

基础款 721_m_4e 设备不检测第一片 ct80，普通款第一片 ct80 的 AIN4 需要根据 fpga 类型判断是否检测，AIN6 是检测 0.9v 还是 1v


#### 待完善项


风扇状态的normal 和 abnormal 判断方式需要修改，auto 模式下不能按照四档调速指定范围来判断，读四个风机的转速，取平均值，每个风机的转速跟平均值比较，相差范围不大就判断是 normal。因为后续风扇硬件类型不一致，用到多种厂家的风扇，无法给出每个占空比下的具体转速，比如说 10% 的转速，各个厂家风扇的实际转速互相比较相差较大，A厂风扇可能是 4000，B厂可能就是 5000。

产测的风扇测试也需要调整，不能按四档配置，然后获取转速比较是否在档位转速范围这种方式，原因同上。测试时，只需要设置几个占空比，比如20%，40%，60%和80%，保证 20% 时，四个风机转速相差不大，然后 40% 时，转速要比 20% 时的转速大（大多少按硬件测试的结果来），四个风机转速也要相差不大。



### tssu 子卡 cpld 升级

命令行`download`需要指定槽位升级，相关功能宏`INCLUDE_ROS_UPGRADE_SLOT` 在产品定义。升级失败，平台的调试信息如下：
```
# 打开download命令相关的调试开关
debugging updown 
terminal debugging console 


itn331e-4xg#
itn331e-4xg#
itn331e-4xg#download cpld tftp 192.168.4.211 slot 3 iTN331-SUB-TSSU_A.0_CPLD_1.1_20250723.tde.bin
1970-01-01,08:29:51  [ros-scrnBg_0]UPDOWN/4/UPGRADETASK: sysm_cli.c-2375 unit:0 slot:3 file:iTN331-SUB-TSSU_A.0_CPLD_1.1_20250723.tde.bin path:(null) isDown:1.
1970-01-01,08:29:51  [ros-Updown]UPDOWN/4/UPDOWN: <UpDownTask>[upgrade.c-4562]: unit:0 slot:3 destfile:17 srcfile:4 dir:1, option:0.
1970-01-01,08:29:51  [ros-Updown]UPDOWN/4/UPDOWN: <UpDownTask>[upgrade.c-4567]:set source ipv4 addr.
1970-01-01,08:29:51  [ros-Updown]UPDOWN/4/UPDOWN: <UpDownTask>[upgrade.c-4583]:source ipaddr: ipv4=0 ipv6=.
SSP_upgrade_hwapi_switch_struct_get[404], get ibc type, slot=3
1970-01-01,08:29:51  [ros-Updown]UPDOWN/1/DOWNLOADFILE: <download_cli_singlefile>[upgrade.c-3443]: slot:3 get ibc type failed. ret:-1.
1970-01-01,08:29:51  [ros-Updown]UPDOWN/4/DOWNLOADFILE: <download_cli_singlefile>[upgrade.c-3473]: slot 3 upgrade temp_path:/tmp/ros/
1970-01-01,08:29:51  [ros-Updown]UPDOWN/4/DOWNLOADFILE: <download_cli_singlefile>[upgrade.c-3764]:filepath=/tmp/cpld.bin.
1970-01-01,08:29:51  [ros-Updown]UPDOWN/1/TFTPGET: VFS_RPC_Open slot 3 file /tmp/cpld.bin failed.
1970-01-01,08:29:51  [ros-Updown]UPDOWN/4/UPDOWN: <UpDownTask>[upgrade.c-4649]: download_cli_singlefile status:1 failcause:9.
1970-01-01,08:29:51  [ros-Updown]UPDOWN/4/UPDOWN: <UpDownTask>[upgrade.c-4687]: send trap success! 
Waiting...
Start ... 
Getting source file from server ..

Open file faild

Set unsuccessfully
itn331e-4xg#
itn331e-4xg#
itn331e-4xg#
itn331e-4xg#
itn331e-4xg#download system tftp 192.168.4.122 system_itn331e_4xg_5gw.bin
1970-01-01,08:29:39  [ros-scrnBg_0]UPDOWN/4/UPGRADETASK: sysm_cli.c-2375 unit:0 slot:0 file:system_itn331e_4xg_5gw.bin path:(null) isDown:1.
1970-01-01,08:29:39  [ros-Updown]UPDOWN/4/UPDOWN: <UpDownTask>[upgrade.c-4562]: unit:0 slot:0 destfile:1 srcfile:4 dir:1, option:0.
1970-01-01,08:29:39  [ros-Updown]UPDOWN/4/UPDOWN: <UpDownTask>[upgrade.c-4567]:set source ipv4 addr.
1970-01-01,08:29:39  [ros-Updown]UPDOWN/4/UPDOWN: <UpDownTask>[upgrade.c-4583]:source ipaddr: ipv4=0 ipv6=.
1970-01-01,08:29:39  [ros-Updown]UPDOWN/4/DOWNLOADFILE: <download_cli_singlefile>[upgrade.c-3473]: slot 0 upgrade temp_path:/tmp/ros/
1970-01-01,08:29:39  [ros-Updown]UPDOWN/4/DOWNLOADFILE: <download_cli_singlefile>[upgrade.c-3764]:filepath=/tmp/ros/system_itn331e_4xg_5gw.bin.
1970-01-01,08:29:39  [ros-Updown]UPDOWN/5/TFTP: host:192.168.4.122 port:69 remotefile:system_itn331e_4xg_5gw.bin vrfid:0.
1970-01-01,08:29:39  [ros-Updown]UPDOWN/5/TFTP: tftp get ...
1970-01-01,08:29:39  [ros-Updown]UPDOWN/4/TFTP: Blocksize oack: 1460, 1460.
1970-01-01,08:29:39  [ros-Updown]UPDOWN/4/TFTP: Timeout oack: 3, 3.
Start ... 
Getting source file from server ..
.................................................................
1970-01-01,08:56:33  [ros-Updown]UPDOWN/4/TFTPGET: tftp res = 1.
1970-01-01,08:56:33  [ros-Updown]UPDOWN/5/DOWNLOADFILE: <process_download_filesystem>[upgrade.c-1125]:filetype:2 localfile:/tmp/ros/system_itn331e_4xg_5gw.bin ulIndex:10.
1970-01-01,08:56:33  [ros-Updown]UPDOWN/5/UPGRADETOWRITE: <UpgradeFileToWrite>[UpgradeHwapi.c-57]: localfile:/tmp/ros/system_itn331e_4xg_5gw.bin filetype:1 ulIndex:10 ulSlotId:0.
upgrade hwapi set cmd: 0xaa00
file to wirte
file type system(1), file:/tmp/ros/system_itn331e_4xg_5gw.bin
#2 currnet image:2, update system:0

Writing file  .....#2 next image:1
bsp_update_system ok, type=1.
1970-01-01,08:56:42  [ros-Updown]UPDOWN/5/UPGRADETOWRITE: <UpgradeFileToWrite>[UpgradeHwapi.c-61]: hwSet return. rc:0.
1970-01-01,08:56:42  [ros-Updown]UPDOWN/4/UPDOWN: <UpDownTask>[upgrade.c-4649]: download_cli_singlefile status:0 failcause:1.
1970-01-01,08:56:42  [ros-Updown]UPDOWN/4/UPDOWN: <UpDownTask>[upgrade.c-4687]: send trap success! 
.
Set successfully

WARNING:download system success, "boot [slot X] next-startup" may needed
itn331e-4xg#
itn331e-4xg#
```

平台从驱动获取板卡的 ibc 类型出错，驱动没有做任何赋值，在 sspUpgradeHw.c 里面直接返回 ROS_ERROR，所以平台这个地方的 ibc_type 就是默认的 UG_IBC_TYPE_ROS，跟平台贾军利沟通确认这个类型需要是 TYPE_OTHER 或者 TYPE_IBCRPC，不支持文件系统 TYPE_ROS 类型。


**升级步骤：**

iTN331-SUB-TSSU：板卡id 为：**0x230b**

1、tssu 板卡的 0x6 寄存器写 0  表示在线加载使能

在tssu cpld升级前, 需要先写 tssu 寄存器打开 升级功能

2、然后配置主板cpld 的复用功能

子卡1  配置下面4个寄存器
在使用复用功能前,先需要读0x101  0x102  0xef  0xf0  四个寄存器的值, 然后按下配置, 

cpld w 0x101 0x01
cpld w 0x102 0x04
cpld w 0xef 0x01
cpld w 0xf0 0x03

升级完成后,需要将0x101  0x102  0xef  0xf0 4个寄存器的 值恢复成升级前的状态  


子卡2  配置下面4个寄存器
在使用复用功能前,先需要读0x104  0x105  0xf2  0xf3  四个寄存器的值, 然后按下配置, 

cpld w 0x104 0x01
cpld w 0x105 0x04
cpld w 0xf2 0x01
cpld w 0xf3 0x03

升级完成后,需要将0x104  0x105  0xf2  0xf3  4个寄存器的 值恢复成升级前的状态  

3、然后关闭tuss 升级功能 写tssu cpld对应寄存器的值 ，tssu 板卡的 0x6的 bit1 写 1

```
btest spi firmware w 3 0x6 1 0x5

btest spi firmware w 0 0x101 1 0x1
btest spi firmware w 0 0x102 1 0x4
btest spi firmware w 0 0xef 1 0x1
btest spi firmware w 0 0xf0 1 0x3



btest spi firmware w 0 0x101 1 0x1
btest spi firmware w 0 0x102 1 0x3
btest spi firmware w 0 0xef 1 0x0
btest spi firmware w 0 0xf0 1 0x0

btest spi firmware w 3 0x6 1 0x7

```





### 主控跳转到子卡串口

子卡1
```
btest spi firmware w 0 0x0e 1 0x00
btest spi firmware w 0 0x0f 1 0x01
```

子卡2
```
btest spi firmware w 0 0x0e 1 0x01
btest spi firmware w 0 0x0f 1 0x01
```

c
```
btest spi firmware w 0 0x0e 1 0x00
btest spi firmware w 0 0x0f 1 0x00
```

